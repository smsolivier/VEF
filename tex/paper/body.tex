%!TEX root = ./jctt.tex

\newcommand{\rell}{^\ell} % raise to ellth power 
\newcommand{\relll}{^{\ell+1}} % raise to ell + 1 th power 
\newcommand{\rellh}{^{\ell+1/2}} % raise to ell + 1/2 power

\newcommand{\paren}[1]{\left(#1\right)} 
\newcommand{\br}[1]{\left[#1\right]}
\newcommand{\curl}[1]{\left\{#1\right\}}

\newcommand{\eddphi}[1]{\edd_{#1}\phi_{#1}}
\newcommand{\ALPHA}[2]{\frac{#1}{\sigma_{t,#2} h_{#2}}}

\section{The VEF Method}
\subsection{The Algorithm}
Here, we describe the VEF method for a planar geometry, fixed-source problem:
	\begin{equation} 
		\mu \pderiv{\psi}{x} \paren{x, \mu} + \sigma_t(x) \psi(x,\mu) = 
			\frac{\sigma_s(x)}{2} \int_{-1}^1 \psi(x,\mu') \ud \mu' + \frac{Q(x)}{2} \,,
	\end{equation}
where $\mu = \cos\theta$ is the cosine of the angle of flight $\theta$ relative to the $x$--axis, $\sigma_t(x)$ and $\sigma_s(x)$ the total and scattering macroscopic cross sections, $Q(x)$ the isotropic fixed-source and $\psi(x, \mu)$ the angular flux. Applying the Discrete Ordinates (\SN) angular discretization yields the following set of $N$ coupled, ordinary differential equations: 
	\begin{equation} \label{eq:sn}
		\mu_n \dderiv{\psi_n}{x}(x) + \sigma_t(x) \psi_n(x) = 
		\frac{\sigma_s(x)}{2} \phi(x) + \frac{Q(x)}{2} \,, 1 \leq n \leq N \,,
	\end{equation}
where $\psi_n(x) = \psi(x, \mu_n)$ is the angular flux in direction $\mu_n$. The $\mu_n$ are stipulated by an $N$-point Gauss quadrature rule such that the scalar flux, $\phi(x)$, can be numerically integrated with: 
	\begin{equation} \label{eq:phiquad}
		\phi(x) = \sum_{n=1}^N w_n \psi_n(x) \,,
	\end{equation}
where the $w_n$ are the quadrature weights corresponding to the $\mu_n$. 

The VEF method decouples Eq. \ref{eq:sn} by lagging the scattering term: 
	\begin{equation} \label{eq:si}
		\mu_n \dderiv{\psi_n\rellh}{x}(x) + \sigma_t(x) \psi_n\rellh(x) = 
		\frac{\sigma_s(x)}{2} \phi^\ell(x) + \frac{Q(x)}{2} \,, 1 \leq n \leq N \,,
	\end{equation}
where the superscripts indicate the iteration index. In Source Iteration (SI), the update 
	\begin{equation} \label{eq:siupdate}
		\phi(x)\relll = \phi(x)\rellh
	\end{equation}
is used. However, this is slow to converge in optically thick and highly scattering systems. Instead, the VEF method solves the VEF drift diffusion equations found by taking the first two angular moments of Eq. \ref{eq:sn}: 
	\begin{subequations} 
	\begin{equation} \label{eq:zero}
		\dderiv{}{x} J\relll(x) + \sigma_a(x) \phi\relll(x) = Q(x) \,,
	\end{equation} 
	\begin{equation} \label{eq:first}
		\frac{\ud}{\ud x} \edd\rellh(x) \phi\relll(x) + \sigma_t(x) J\relll(x) = 0 \,,
	\end{equation}
	\end{subequations}
where $J\relll(x)$ is the current and 
	\begin{equation} \label{eq:eddington} 
		\edd\rellh(x) = \frac{\int_{-1}^1 \mu^2 \psi\rellh(x, \mu) \ud \mu}{\int_{-1}^1 \psi\rellh(x, \mu) \ud \mu}
		\xrightarrow{\text{\SN}} \frac{
			\sum_{n=1}^N \mu_n^2 \psi_n\rellh(x) w_n
		}{
			\sum_{n=1}^N \psi_n\rellh(x) w_n 
		}
	\end{equation}
the Eddington factor. The scattering term in Eq. \ref{eq:si} is then updated with the VEF drift diffusion scalar flux found by solving Eqs. \ref{eq:zero} and \ref{eq:first}. This process of solving Eq. \ref{eq:si} for the $\psi_n(x)$, computing the Eddington factor, solving the VEF drift diffusion equation for the scalar flux, and updating the scattering term with the VEF drift diffusion scalar flux is repeated convergence. 

Acceleration occurs because the angular shape of the angular flux, and thus the Eddington factor, converges much faster than the scalar flux. In addition, the VEF equations model the contributions of all scattering events at once, reducing the dependence on source iterations to introduce scattering information. 
% The solution from the VEF equations is then an approximation for the full flux and not the $\ell - 1$ collided flux as it was without acceleration. 

In addition to acceleration, this scheme allows the \SN equations and drift diffusion equations to be solved with arbitrarily different spatial discretization methods. The following sections  present the application of the Lumped Linear Discontinuous Galerkin (LLDG) spatial discretization to the \SN equations and the Mixed Finite Element Method (MFEM) to the VEF drift diffusion equations. 

\subsection{Lumped Linear Discontinuous Galerkin \SN}
\begin{figure}
	\centering
	\input{figs/lldggrid.pdf_tex}
	\caption{The distribution of unknowns in an LLDG cell. The superscript $+$ and $-$ indicate the angular fluxes for $\mu_n>0$ and $\mu_n<0$, respectively. } 
\end{figure}
The LLDG discretization of Eq. \ref{eq:si} is: 
	\begin{subequations} 
	\begin{equation} \label{eq:lldg_l}
		\mu_n \left(\psi_{n,i}\rellh - \psi_{n, i-1/2}\rellh\right) 
		+ \frac{\sigma_{t,i} h_i}{2} \psi_{n,i,L}\rellh
		= \frac{\sigma_{s,i} h_i}{4} \phi_{i,L}\rell + \frac{h_i}{4} Q_{i,L} \,, 
		% 1 \leq n \leq N \,, 
		% 1 \leq i \leq I\,, 
	\end{equation}
	\begin{equation} \label{eq:lldg_r}
		\mu_n \left(\psi_{n,i+1/2}\rellh - \psi_{n,i}\rellh\right) 
		+ \frac{\sigma_{t,i} h_i}{2} \psi_{n,i,R}\rellh
		= \frac{\sigma_{s,i} h_i}{4} \phi_{i,R}\rell + \frac{h_i}{4} Q_{i,R} \,, 
		% 1 \leq n \leq N \,, 
		% 1 \leq i \leq I\,,
	\end{equation}
	\end{subequations}
where $h_i$, $\sigma_{t,i}$, and $\sigma_{s,i}$ are the cell width, total cross section, and scattering cross section in cell $i$. The $i,L$ and $i,R$ subscripts indicate the the subscripted value is the left or right discontinuous edge value. The cell centered angular flux is the average of the left and right discontinuous edge fluxes:
	\begin{equation} \label{eq:lldg_i}
		\psi_{n,i}\rellh = \half\left(\psi_{n,i,L}\rellh + \psi_{n,i,R}\rellh\right) \,.
	\end{equation}
The cell edged angular fluxes are defined through upwinding: 
	\begin{subequations}
	\begin{equation} \label{eq:downwind}
		\psi_{n,i-1/2}\rellh = \begin{cases}
			\psi_{n,i-1,R}\rellh \,, & \mu_n > 0 \\ 
			\psi_{n,i,L}\rellh \,, & \mu_n < 0 
		\end{cases} \,,
	\end{equation}
	\begin{equation} \label{eq:upwind}
		\psi_{n,i+1/2}\rellh = \begin{cases}
			\psi_{n,i,R}\rellh \,, & \mu_n > 0 \\
			\psi_{n,i+1,L}\rellh \,, & \mu_n < 0 
		\end{cases} \,.
	\end{equation}
	\end{subequations}
Equations \ref{eq:lldg_l}, \ref{eq:lldg_r}, \ref{eq:lldg_i}, \ref{eq:downwind}, and \ref{eq:upwind} can be combined and rewritten as 
	\begin{equation} \label{eq:sweepLR}
		\left[\begin{matrix}
			\mu_n + \sigma_{t,i} h_i & \mu_n  \\ 
			-\mu_n & \sigma_{t,i} + \mu_n \\ 
		\end{matrix}\right]
		\left[\begin{matrix}
			\psi_{n,i,L}\rellh \\ \psi_{n,i,R}\rellh
		\end{matrix}\right]
		= \left[\begin{matrix}
			\frac{\sigma_{s,i}h_i}{2} \phi_{i,L}\rell + \frac{h_i}{2} Q_{i,L} + 2\mu_n \psi_{n,i-1,R}\rellh \\
			\frac{\sigma_{s,i}h_i}{2} \phi_{i,R}\rell + \frac{h_i}{2} Q_{i,R} 
		\end{matrix}\right] \,, 
	\end{equation}
for sweeping from left to right ($\mu_n > 0$) and 
	\begin{equation} \label{eq:sweepRL}
		\left[\begin{matrix} 
			-\mu_n + \sigma_{t,i}h_i & \mu_n \\ 
			-\mu_n & -\mu_n + \sigma_{t,i}h_i \\ 
		\end{matrix} \right]
		\left[\begin{matrix}
			\psi_{n,i,L}\rellh \\ \psi_{n,i,R}\rellh
		\end{matrix} \right]
		= \left[\begin{matrix}
			\frac{\sigma_{s,i}h_i}{2} \phi_{i,L}\rell + \frac{h_i}{2} Q_{i,L} \\ 
			\frac{\sigma_{s,i}h_i}{2} \phi_{i,R}\rell + \frac{h_i}{2} Q_{i,R} - 2\mu_n \psi_{n,i+1,L}\rellh
		\end{matrix} \right]
		\,, 
	\end{equation}
for sweeping from right to left ($\mu_n < 0$). The right hand sides of Eqs. \ref{eq:sweepLR} and \ref{eq:sweepRL} are known as the scalar flux from the previous iteration, the fixed source, and the angular flux entering from the previous cell are all known. By supplying the flux entering the left side of the first cell, the positive-angled solution can be propagated from left to right by solving Eq. \ref{eq:sweepLR}. Similarly, supplying the incident flux on the right boundary allows the negative-angled solution to be propagated from right to left with Eq. \ref{eq:sweepRL}. 

\subsection{Mixed Finite Element Method VEF Drift Diffusion}
\begin{figure}
	\centering
	% \def\svgwidth{\textwidth}
	\input{figs/mfemgrid.pdf_tex} 
	\caption{The distribution of unknowns in cell $i$ for MFEM. }
	\label{fig:mfem_grid}
\end{figure}
The unknowns in an MFEM cell are depicted in Fig. \ref{fig:mfem_grid}. The scalar flux is constant within the cell with discontinuous jumps at the cell edges and the current is a linear function defined by: 
	\begin{equation} \label{eq:MFEM_current}
		J_i(x) = J_{i,L} B_{i,L}(x) + J_{i,R} B_{R,i}(x) \,, 
	\end{equation} 
where $J_{i,L/R}$ are the currents at the left and right edges of the cell and 
	\begin{subequations}
		\begin{equation}
			B_{i,L}(x) = \begin{cases}
				\frac{x_{i+1/2} - x}{h_i} \,, & x \in [x_{i-1/2}, x_{i+1/2}] \\ 
				0 \,, & \text{otherwise}
			\end{cases} \,,
		\end{equation}
		\begin{equation}
			B_{i,R}(x) = \begin{cases}
				\frac{x - x_{i-1/2}}{h_i} \,, & x \in [x_{i-1/2}, x_{i+1/2}] \\ 
				0 \,, & \text{otherwise}
			\end{cases} \,,
		\end{equation}
	\end{subequations}
are the MFEM basis functions. 

The spatial grid used in the MFEM VEF step is identical to the grid used in the LLDG \SN discretization. Overlap between the methods occurs in transferring the Eddington factor from LLDG \SN to MFEM VEF drift diffusion. MFEM requires the Eddington factor on the cell edges and cell centers. The edge values of the Eddington factor can be found by using the edge angular flux defined in Eqs. \ref{eq:downwind} and \ref{eq:upwind}. Two methods have been tested for the cell centers. The first method averages the edge Eddington factors and the second represents the LLDG angular flux as a linear function of the MFEM basis functions: 
	\begin{equation} \label{mfem:ldconsistent}
		\edd_i(x) = \frac{
			\sum_{n=1}^N \mu_n^2 \left[\psi_{n,i,L}B_{i,L}(x) + \psi_{n,i,R} B_{i,R}(x)\right]
		}
		{
			B_{i,L}(x) \sum_{n=1}^N w_n \psi_{n,i,L} + B_{i,R}(x) \sum_{n=1}^N w_n \psi_{n,i,R} 
		} \,. 
	\end{equation} 

The MFEM representation yields five unknowns per cell: $\phi_{i-1/2}$, $\phi_i$, $\phi_{i+1/2}$, $J_{i,L}$, and $J_{i,R}$. An equation for $\phi_i$ is found by integrating Eq. \ref{eq:zero} over cell $i$: 
	\begin{equation} \label{mfem:balance}
		J_{i,R} - J_{i,L} + \sigma_{a,i} h_i \phi_i = Q_i h_i \,,
	\end{equation}
where $\sigma_{a,i}$ and $Q_i$ are the absorption cross section and source in cell $i$. Equations for $J_{i,L/R}$ are found by multiplying Eq. \ref{eq:first} by $B_{i,L/R}$ and integrating over cell $i$: 
	\begin{subequations}
		\begin{equation} \label{mfem:bli}
			-\edd_{i-1/2} \phi_{i-1/2} + \edd_i \phi_i + \sigma_{t,i} h_i \left(\frac{1}{3} J_{i,L} + \frac{1}{6}J_{i,R}\right) = 0 \,,
		\end{equation}
		\begin{equation} \label{mfem:bri}
			\edd_{i+1/2} \phi_{i+1/2} - \edd_i \phi_i + \sigma_{t,i} h_i \left(\frac{1}{6} J_{i,L} + \frac{1}{3} J_{i,R}\right) = 0 \,, 
		\end{equation}
	\end{subequations}
where the Eddington factor is evaluated at iteration $\ell+1/2$ and the fixed source has been assumed to be isotropic. The cell centered Eddington factor given in Eq. \ref{mfem:ldconsistent} is a rational polynomial and cannot be integrated analytically. In this case, two point Gauss quadrature was used to numerically integrate Eq. \ref{mfem:ldconsistent} over the interior of cell $i$: 
	\begin{equation} 
		\edd_i = \frac{1}{2} \br{\edd_i(x_{i,L}) + \edd_i(x_{i,R})} \,, 
	\end{equation}
where 
	\begin{equation} 
		x_{i,L/R} = \frac{h_i}{2} \mp \frac{x_{i+1/2} + x_{i-1/2}}{2\sqrt{3}}
	\end{equation}
are the quadrature points in the cell. 
Eliminating $J_{i,R}$ and $J_{i,L}$ yields: 
	\begin{subequations}
		\begin{equation} \label{mfem:jli}
			J_{i,L} = \frac{-2}{\sigma_{t,i} h_i} \bigg\{
				2\br{\eddphi{i} - \eddphi{i-1/2}}
				- \br{\eddphi{i+1/2} - \eddphi{i}}
			\bigg\} \,,
		\end{equation}
		\begin{equation} \label{mfem:jri}
			J_{i,R} = \frac{-2}{\sigma_{t,i} h_i} \bigg\{
				2\br{\eddphi{i+1/2} - \eddphi{i}} 
				- \br{\eddphi{i} - \eddphi{i-1/2}}
			\bigg\} \,.
		\end{equation}
	\end{subequations}
The fourth equation is found by enforcing continuity of current: 
	\begin{equation} \label{mfem:continuity}
		J_{i,R} = J_{i+1, L} \,. 
	\end{equation}

Using the definitions of $J_{i,L}$ and $J_{i,R}$ from Eqs. \ref{mfem:jli} and \ref{mfem:jri} in the balance equation (Eq. \ref{mfem:balance}) and continuity equation (Eq. \ref{mfem:continuity}) reduces the system to three unknowns per cell: $\phi_{i-1/2}$, $\phi_i$, and $\phi_{i+1/2}$. The resulting equations for $\phi_i$ and $\phi_{i+1/2}$ are: 
	\begin{subequations}
		\begin{equation} \label{mfem:center}
			-\frac{6}{\sigma_{t,i}h_i} \edd_{i-1/2} \phi_{i-1/2}
			+ \left(\frac{12}{\sigma_{t,i}h_i} \edd_i + \sigma_{a,i} h_i\right) \phi_i 
			- \frac{6}{\sigma_{t,i} h_i} \edd_{i+1/2} \phi_{i+1/2} 
			= Q_i h_i \,,
		\end{equation}
		\begin{multline} \label{mfem:edge}
			-\ALPHA{2}{i} \eddphi{i-1/2} + \ALPHA{6}{i} \eddphi{i} 
			- 4\paren{\ALPHA{1}{i} + \ALPHA{1}{i+1}} \eddphi{i+1/2} \\
			+ \ALPHA{6}{i+1}\eddphi{i+1} 
			- \ALPHA{2}{i+1} \eddphi{i+3/2}
			= 0 \,. 
		\end{multline}
	\end{subequations}
On the interior, $\phi_{i-1/2} = \phi_{(i-1)+1/2}$. Thus, Eqs. \ref{mfem:center} and \ref{mfem:edge} are sufficient to specify the center and edge scalar fluxes on the interior. The remaining unknowns, $\phi_{1/2}$ and $\phi_{I+1/2}$, are set by the boundary conditions. Equations for $\phi_{1/2}$ and $\phi_{I+1/2}$ are found by setting the $J_{1,L}$ and $J_{I,R}$ to a supplied boundary current. For example, a vacuum condition can be applied on the left boundary through a modified Marshak boundary: 
	\begin{equation}
		J_{1,L} = B_{1/2} \phi_{1/2} \,,
	\end{equation}  
where $J_{1,L}$ is defined in Eq. \ref{mfem:jli} and 
	\begin{equation}
		B_{1/2} = \frac{\sum_{n=1}^N |\mu_n| \psi_{n,1/2} w_n}{
			\sum_{n=1}^N \psi_{n,1/2} w_n 
		} \,. 
	\end{equation}
A left reflecting condition is set by 
	\begin{equation}
		J_{1,L} = 0 \,. 
	\end{equation} 
This system of $2I+1$ equations was assembled into a matrix with both cell centered and cell edge scalar fluxes and solved with a five band matrix solver. 

% Applying the MFEM to Eqs. \ref{eq:zero} and \ref{eq:first} and enforcing continuity of current yields: 
% 	\begin{subequations} \label{eq:mfem}
	
% 	\begin{multline}
% 		-\frac{2}{\sigma_{t,i} h_i} \edd_{i-1/2}\phi_{i-1/2} + 
% 		\frac{6}{\sigma_{t,i} h_i} \edd_i \phi_i 
% 		- 4\left(\frac{1}{\sigma_{t,i} h_i} + \frac{1}{\sigma_{t,i+1} h_{i+1}}\right) 
% 			\edd_{i+1/2} \phi_{i+1/2}
% 		\\ + \frac{6}{\sigma_{t,i+1} h_{i+1}} \edd_{i+1} \phi_{i+1} 
% 		- \frac{2}{\sigma_{t,i+1} h_{i+1}} \edd_{i+3/2} \phi_{i+3/2} 
% 		= 0 \,,
% 	\end{multline}
% 	\end{subequations}
% where the Eddington factor is evaluated at iteration $\ell+1/2$ and the scalar flux at $\ell+1$. 
% Here, the Eddington factor has been assumed to be constant in each cell with discontinuous jumps at the edges. 
% The simplest method of converting the Eddington factor from LLDG to MFEM is to compute the Eddington factor using the cell centered and cell edged angular fluxes using Eqs. \ref{eq:lldg_i}, \ref{eq:downwind}, and \ref{eq:upwind}. A more consistent way to transfer the Eddington factor is to represent the LLDG angular flux as a linear function using the MFEM basis functions: 
% 	\begin{equation} \label{eq:eddquad}
% 		\edd_i(x) = \frac{
% 			\sum_{n=1}^N \mu_n^2 \left[\psi_{n,i,L}B_{i,L}(x) + \psi_{n,i,R} B_{i,R}(x)\right]
% 		}
% 		{
% 			B_{i,L}(x) \sum_{n=1}^N w_n \psi_{n,i,L} + B_{i,R}(x) \sum_{n=1}^N w_n \psi_{n,i,R} 
% 		} \,,
% 	\end{equation}
% where 
	
% and 

% When MFEM is applied, the integral over cell $i$ of the rational polynomial given in Eq. \ref{eq:eddquad} is approximated with 2 point Gauss quadrature. The cell centered Eddington factors used in Eq. \ref{eq:mfem} are then: 
% 	\begin{equation} 
% 		\edd_i = \half \left[ \edd_i(x_{i,L}) + \edd_i(x_{i,R}) \right] \,,
% 	\end{equation}
% where 
% 	\begin{equation}
% 		x_{i,L/R} = \frac{x_{i+1/2} - x_{i-1/2}}{2} \mp \frac{x_{i+1/2} + x_{i-1/2}}{2\sqrt{3}}
% 	\end{equation}
% are the quadrature points in cell $i$. 

% Transport consistent vacuum boundary conditions are applied through a modified Marshak boundary condition: 
% 	\begin{equation} 
% 		J(x) = B(x) \phi(x) \,,
% 	\end{equation} 
% where 
% 	\begin{equation} 
% 		B(x) = \frac{\int_{-1}^1 |\mu| \psi(x, \mu) \ud \mu}
% 		{\int_{-1}^1 \psi(x, \mu) \ud \mu} \,. 
% 	\end{equation}

Once the MFEM scalar flux has been found, the LLDG scattering term must be reconstructed. Two methods have been tested: no reconstruction and van Leer limited cell centered slope reconstruction. The no reconstruction method sets the LLDG discontinuous left and right scalar flux to the MFEM edge scalar flux: 
	\begin{equation} 
		\phi_{i,L/R} = \phi_{i\mp1/2} \,,
	\end{equation} 
where the left hand side is the reconstructed LLDG flux used in the scattering term of Eq. \ref{eq:si} and the right hand side the MFEM drift diffusion flux. The van Leer cell centered reconstruction is: 
	\begin{equation} 
		\phi_{i,L/R} = \phi_i \mp \frac{1}{4} \xi_\text{van Leer} \left[\left(\phi_{i+1} - \phi_i\right) + \left(\phi_i - \phi_{i-1}\right) \right] \,,
	\end{equation}
where $\xi_\text{van Leer}$ the slope limiter given in \cite{vanLeer}. 