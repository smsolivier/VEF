%!TEX root = ./jctt.tex

\subsection{Mixed Finite Element Method VEF Drift Diffusion}
\begin{figure}
	\centering
	% \def\svgwidth{\textwidth}
	\input{figs/mfemgrid.pdf_tex} 
	\caption{The distribution of unknowns in cell $i$ for MFEM. }
	\label{fig:mfem_grid}
\end{figure}
The unknowns in an MFEM cell are depicted in Fig. \ref{fig:mfem_grid}. The scalar flux is constant within the cell with discontinuous jumps at the cell edges and the current is a linear function defined by: 
	\begin{equation} \label{eq:MFEM_current}
		J_i(x) = J_{i,L} B_{i,L}(x) + J_{i,R} B_{R,i}(x) \,, 
	\end{equation} 
where $J_{i,L/R}$ are the currents at the left and right edges of the cell and 
	\begin{subequations}
		\begin{equation}
			B_{i,L}(x) = \begin{cases}
				\frac{x_{i+1/2} - x}{h_i} \,, & x \in [x_{i-1/2}, x_{i+1/2}] \\ 
				0 \,, & \text{otherwise}
			\end{cases} \,,
		\end{equation}
		\begin{equation}
			B_{i,R}(x) = \begin{cases}
				\frac{x - x_{i-1/2}}{h_i} \,, & x \in [x_{i-1/2}, x_{i+1/2}] \\ 
				0 \,, & \text{otherwise}
			\end{cases} \,,
		\end{equation}
	\end{subequations}
are the MFEM basis functions. The spatial grid used in this step is identical to the grid used in the LLDG \SN step. 

The MFEM representation yields five unknowns per cell: $\phi_{i-1/2}$, $\phi_i$, $\phi_{i+1/2}$, $J_{i,L}$, and $J_{i,R}$. An equation for $\phi_i$ is found by integrating Eq. \ref{eq:zero} over cell $i$: 
	\begin{equation} \label{mfem:balance}
		J_{i,R} - J_{i,L} + \sigma_{a,i} h_i \phi_i = Q_i h_i \,,
	\end{equation}
where $\sigma_{a,i}$ and $Q_i$ are the absorption cross section and source in cell $i$. Equations for $J_{i,L/R}$ are found by multiplying Eq. \ref{eq:first} by $B_{i,L/R}$ and integrating over cell $i$: 
	\begin{subequations}
		\begin{equation} \label{mfem:bli}
			-\edd_{i-1/2} \phi_{i-1/2} + \edd_i \phi_i + \sigma_{t,i} h_i \left(\frac{1}{3} J_{i,L} + \frac{1}{6}J_{i,R}\right) = 0 \,,
		\end{equation}
		\begin{equation} \label{mfem:bri}
			\edd_{i+1/2} \phi_{i+1/2} - \edd_i \phi_i + \sigma_{t,i} h_i \left(\frac{1}{6} J_{i,L} + \frac{1}{3} J_{i,R}\right) = 0 \,, 
		\end{equation}
	\end{subequations}
where the fixed source has been assumed to be isotropic. The Eddington factors, $\edd_{i(\pm1/2)}$, are computed using the angular fluxes from the LLDG \SN step according to: 
	\begin{equation} 
		\edd_{i(\pm1/2)} = \frac{
			\sum_{n=1}^N \mu_n^2 \psi_{n,i(\pm1/2)} w_n 
		}{
			\sum_{n=1}^N \psi_{n,i(\pm1/2)} w_n
		} \,,
	\end{equation}
where the cell edge angular fluxes are defined by Eq. \ref{eq:downwind} and \ref{eq:upwind} and the cell centered angular flux by Eq. \ref{eq:lldg_i}. 
Eliminating $J_{i,R}$ from Eq. \ref{mfem:bli} and $J_{i,L}$ from Eq. \ref{mfem:bri} yields: 
	\begin{subequations}
		\begin{equation} \label{mfem:jli}
			J_{i,L} = \frac{-2}{\sigma_{t,i} h_i} \bigg\{
				2\br{\eddphi{i} - \eddphi{i-1/2}}
				- \br{\eddphi{i+1/2} - \eddphi{i}}
			\bigg\} \,,
		\end{equation}
		\begin{equation} \label{mfem:jri}
			J_{i,R} = \frac{-2}{\sigma_{t,i} h_i} \bigg\{
				2\br{\eddphi{i+1/2} - \eddphi{i}} 
				- \br{\eddphi{i} - \eddphi{i-1/2}}
			\bigg\} \,.
		\end{equation}
	\end{subequations}
A fourth equation is found by enforcing continuity of current: 
	\begin{equation} \label{mfem:continuity}
		J_{i,R} = J_{i+1, L} \,. 
	\end{equation}

Using the definitions of $J_{i,L}$ and $J_{i,R}$ from Eqs. \ref{mfem:jli} and \ref{mfem:jri} in the balance equation (Eq. \ref{mfem:balance}) and continuity equation (Eq. \ref{mfem:continuity}) reduces the system to three unknowns per cell: $\phi_{i-1/2}$, $\phi_i$, and $\phi_{i+1/2}$. The resulting balance and continuity equations are:
	\begin{subequations}
		\begin{equation} \label{mfem:center}
			-\frac{6}{\sigma_{t,i}h_i} \edd_{i-1/2} \phi_{i-1/2}
			+ \left(\frac{12}{\sigma_{t,i}h_i} \edd_i + \sigma_{a,i} h_i\right) \phi_i 
			- \frac{6}{\sigma_{t,i} h_i} \edd_{i+1/2} \phi_{i+1/2} 
			= Q_i h_i \,,
		\end{equation}
		\begin{multline} \label{mfem:edge}
			-\ALPHA{2}{i} \eddphi{i-1/2} + \ALPHA{6}{i} \eddphi{i} 
			- 4\paren{\ALPHA{1}{i} + \ALPHA{1}{i+1}} \eddphi{i+1/2} \\
			+ \ALPHA{6}{i+1}\eddphi{i+1} 
			- \ALPHA{2}{i+1} \eddphi{i+3/2}
			= 0 \,. 
		\end{multline}
	\end{subequations}
On the interior, $\phi_{i-1/2} = \phi_{(i-1)+1/2}$. Thus, Eqs. \ref{mfem:center} and \ref{mfem:edge} are sufficient to specify the center and edge scalar fluxes on the interior. The remaining unknowns, $\phi_{1/2}$ and $\phi_{I+1/2}$, are set by the boundary conditions. Equations for $\phi_{1/2}$ and $\phi_{I+1/2}$ are found by setting the equations for $J_{1,L}$ and $J_{I,R}$ to a supplied boundary current. For example, a vacuum condition can be applied on the left boundary through a modified Marshak boundary: 
	\begin{equation}
		J_{1,L} = B_{1/2} \phi_{1/2} \,,
	\end{equation}  
where $J_{1,L}$ is defined in Eq. \ref{mfem:jli} and 
	\begin{equation}
		B_{1/2} = \frac{\sum_{n=1}^N |\mu_n| \psi_{n,1/2} w_n}{
			\sum_{n=1}^N \psi_{n,1/2} w_n 
		} \,. 
	\end{equation}
A left reflecting condition is set by 
	\begin{equation}
		J_{1,L} = 0 \,. 
	\end{equation} 
This system of $2I+1$ equations can be assembled into a matrix of both cell centered and cell edge scalar fluxes and solved with a banded matrix solver of bandwidth five. 

% Applying the MFEM to Eqs. \ref{eq:zero} and \ref{eq:first} and enforcing continuity of current yields: 
% 	\begin{subequations} \label{eq:mfem}
	
% 	\begin{multline}
% 		-\frac{2}{\sigma_{t,i} h_i} \edd_{i-1/2}\phi_{i-1/2} + 
% 		\frac{6}{\sigma_{t,i} h_i} \edd_i \phi_i 
% 		- 4\left(\frac{1}{\sigma_{t,i} h_i} + \frac{1}{\sigma_{t,i+1} h_{i+1}}\right) 
% 			\edd_{i+1/2} \phi_{i+1/2}
% 		\\ + \frac{6}{\sigma_{t,i+1} h_{i+1}} \edd_{i+1} \phi_{i+1} 
% 		- \frac{2}{\sigma_{t,i+1} h_{i+1}} \edd_{i+3/2} \phi_{i+3/2} 
% 		= 0 \,,
% 	\end{multline}
% 	\end{subequations}
% where the Eddington factor is evaluated at iteration $\ell+1/2$ and the scalar flux at $\ell+1$. 
% Here, the Eddington factor has been assumed to be constant in each cell with discontinuous jumps at the edges. 
% The simplest method of converting the Eddington factor from LLDG to MFEM is to compute the Eddington factor using the cell centered and cell edged angular fluxes using Eqs. \ref{eq:lldg_i}, \ref{eq:downwind}, and \ref{eq:upwind}. A more consistent way to transfer the Eddington factor is to represent the LLDG angular flux as a linear function using the MFEM basis functions: 
% 	\begin{equation} \label{eq:eddquad}
% 		\edd_i(x) = \frac{
% 			\sum_{n=1}^N \mu_n^2 \left[\psi_{n,i,L}B_{i,L}(x) + \psi_{n,i,R} B_{i,R}(x)\right]
% 		}
% 		{
% 			B_{i,L}(x) \sum_{n=1}^N w_n \psi_{n,i,L} + B_{i,R}(x) \sum_{n=1}^N w_n \psi_{n,i,R} 
% 		} \,,
% 	\end{equation}
% where 
	
% and 

% When MFEM is applied, the integral over cell $i$ of the rational polynomial given in Eq. \ref{eq:eddquad} is approximated with 2 point Gauss quadrature. The cell centered Eddington factors used in Eq. \ref{eq:mfem} are then: 
% 	\begin{equation} 
% 		\edd_i = \half \left[ \edd_i(x_{i,L}) + \edd_i(x_{i,R}) \right] \,,
% 	\end{equation}
% where 
% 	\begin{equation}
% 		x_{i,L/R} = \frac{x_{i+1/2} - x_{i-1/2}}{2} \mp \frac{x_{i+1/2} + x_{i-1/2}}{2\sqrt{3}}
% 	\end{equation}
% are the quadrature points in cell $i$. 

% Transport consistent vacuum boundary conditions are applied through a modified Marshak boundary condition: 
% 	\begin{equation} 
% 		J(x) = B(x) \phi(x) \,,
% 	\end{equation} 
% where 
% 	\begin{equation} 
% 		B(x) = \frac{\int_{-1}^1 |\mu| \psi(x, \mu) \ud \mu}
% 		{\int_{-1}^1 \psi(x, \mu) \ud \mu} \,. 
% 	\end{equation}

Increased consistency Two methods have been tested for generating the cell centered Eddington factors: averaging the cell edge values and representing the LLDG angular flux as a linear function of the MFEM basis functions: 
	\begin{equation} \label{mfem:ldconsistent}
		\edd_i(x) = \frac{
			\sum_{n=1}^N \mu_n^2 \left[\psi_{n,i,L}B_{i,L}(x) + \psi_{n,i,R} B_{i,R}(x)\right]
		}
		{
			B_{i,L}(x) \sum_{n=1}^N w_n \psi_{n,i,L} + B_{i,R}(x) \sum_{n=1}^N w_n \psi_{n,i,R} 
		} \,. 
	\end{equation}
Equation \ref{mfem:ldconsistent} is a rational polynomial and cannot be integrated analytically. In this case, two point Gauss quadrature was used to numerically integrate Eq. \ref{mfem:ldconsistent} over the interior of cell $i$: 
	\begin{equation} 
		\edd_i = \frac{1}{2} \br{\edd_i(x_{i,L}) + \edd_i(x_{i,R})} \,, 
	\end{equation}
where 
	\begin{equation} 
		x_{i,L/R} = \frac{h_i}{2} \mp \frac{x_{i+1/2} + x_{i-1/2}}{2\sqrt{3}}
	\end{equation}
are the quadrature points in the cell. 

Once the MFEM scalar flux has been found, the LLDG scattering term must be reconstructed. Two methods have been tested: no reconstruction and van Leer limited cell centered slope reconstruction. The no reconstruction method sets the LLDG discontinuous left and right scalar flux to the MFEM edge scalar flux: 
	\begin{equation} 
		\phi_{i,L/R} = \phi_{i\mp1/2} \,,
	\end{equation} 
where the left hand side is the reconstructed LLDG flux used in the scattering term of Eq. \ref{eq:si} and the right hand side the MFEM drift diffusion flux. The van Leer cell centered reconstruction is: 
	\begin{equation} 
		\phi_{i,L/R} = \phi_i \mp \frac{1}{4} \xi_\text{van Leer} \left[\left(\phi_{i+1} - \phi_i\right) + \left(\phi_i - \phi_{i-1}\right) \right] \,,
	\end{equation}
where $\xi_\text{van Leer}$ the slope limiter given in \cite{vanLeer}. 