%!TEX root = ./jctt.tex

\newcommand{\rell}{^\ell} % raise to ellth power 
\newcommand{\relll}{^{\ell+1}} % raise to ell + 1 th power 
\newcommand{\rellh}{^{\ell+1/2}} % raise to ell + 1/2 power 

\subsection{The Algorithm}
The steady state, one group, isotropically scattering, slope reconstruction fixed source Linear Boltzmann Equation in 1-D slab geometry is: 
	\begin{equation} \label{eq:bte}
		\mu \pderiv{\psi}{x}(x, \mu) + \sigma_t(x) \psi(x,\mu) = 
		\frac{\sigma_s(x)}{2} \int_{-1}^{1} \psi(x, \mu') d\mu' + \frac{Q(x)}{2} \,,
	\end{equation}
where $\mu = \cos\theta$ is the cosine of the angle of flight $\theta$ relative to the $x$--axis, $\sigma_t(x)$ and $\sigma_s(x)$ the total and scattering macroscopic cross sections, $Q(x)$ the isotropic fixed-source and $\psi(x, \mu)$ the angular flux. Applying the Discrete Ordinates angular discretization yields the following set of $N$ coupled, ordinary differential equations: 
	\begin{equation} \label{eq:sn}
		\mu_n \dderiv{\psi_n}{x}(x) + \sigma_t(x) \psi_n(x) = 
		\frac{\sigma_s(x)}{2} \phi(x) + \frac{Q(x)}{2} \,, 1 \leq n \leq N \,,
	\end{equation}
where $\psi_n(x) = \psi(x, \mu_n)$ is the angular flux in direction $\mu_n$. The scalar flux, $\phi(x)$, is computed using an $N$-point Gauss quadrature rule such that 
	\begin{equation} \label{eq:phiquad}
		\phi(x) = \sum_{n=1}^N w_n \psi_n(x) \,.
	\end{equation}
The Source Iteration (SI) scheme decouples the system of equations defined by Eq. \ref{eq:sn} by lagging the scattering term. In other words, 
	\begin{equation} \label{eq:si}
		\mu_n \dderiv{\psi_n\relll}{x}(x) + \sigma_t(x) \psi_n\relll(x) = 
		\frac{\sigma_s(x)}{2} \phi^\ell(x) + \frac{Q(x)}{2} \,, 1 \leq n \leq N \,,
	\end{equation}
where the superscripts indicate the iteration index. SI is then: solve Eq. \ref{eq:si} for the $\psi_n(x)$, compute the scalar flux using Eq. \ref{eq:phiquad}, update the scalar flux on the right side of Eq. \ref{eq:si}, and repeat until the scalar flux converges. 

The VEF method adds a drift diffusion acceleration step to increase the rate of convergence of SI. The VEF drift diffusion equations are found by taking the first two moments of Eq. \ref{eq:bte}: 
	\begin{subequations} 
	\begin{equation} \label{eq:zero}
		\dderiv{}{x} J(x) + \sigma_a(x) \phi(x) = Q(x) \,,
	\end{equation} 
	\begin{equation} \label{eq:first}
		\frac{\ud}{\ud x} \edd(x) \phi(x) + \sigma_t(x) J(x) = 0 \,,
	\end{equation}
	\end{subequations}
where $J(x) = \int_{-1}^1 \mu \psi_(x, \mu) \ud \mu$ is the current and 
	\begin{equation} \label{eq:eddington} 
		\edd(x) = \frac{\int_{-1}^1 \mu^2 \psi(x, \mu) \ud \mu}{\int_{-1}^1 \psi(x, \mu) \ud \mu}
	\end{equation}
the Eddington factor. By computing the Eddington factor with the \SN angular flux, Eqs. \ref{eq:zero} and \ref{eq:first} can be solved directly for the scalar flux. The drift diffusion scalar flux can then be used to update the scattering term on the right side of Eq. \ref{eq:si}. The VEF method is: 
	\begin{enumerate}
		\item Given the previous estimate for the scalar flux, $\phi^{\ell}(x)$, solve Eq. \ref{eq:si} for $\psi_n^{\ell+1/2}(x)$. 
		\item Compute $\edd^{\ell+1/2}(x)$ with: 
			\begin{equation*}
				\edd\rellh(x) = \frac{\sum_{n=1}^N \mu_n^2 \psi_n\rellh(x)}{\sum_{n=1}^N \psi_n\rellh(x)} \,.
			\end{equation*}
		% \item Interpolate $\edd(x)$ onto the MHFEM grid 
		\item Solve Eqs. \ref{eq:zero} and \ref{eq:first} for $\phi^{\ell+1}(x)$ using $\edd^{\ell+1/2}(x)$. 
		% \item Use the moment equations' $\phi(x)$ on the right hand side of Eq. \ref{eq:si}.  
		\item Update the scalar flux estimate on the right side of Eq. \ref{eq:si} with $\phi^{\ell+1}(x)$ and repeat the iteration process until the scalar flux converges. 
	\end{enumerate}
Acceleration occurs because the angular shape of the angular flux, and thus the Eddington factor, converges much faster than the scalar flux. In addition, the VEF equations model the contributions of all scattering events at once, reducing the dependence on source iterations to introduce scattering information. The solution from the VEF equations is then an approximation for the full flux and not the $\ell - 1$ collided flux as it was without acceleration. 

In addition to acceleration, this scheme allows the \SN equations and drift diffusion equations to be solved with arbitrarily different spatial discretization methods. The following sections  present the application of the Lumped Linear Discontinuous Galerkin (LLDG) spatial discretization to the \SN equations and the Mixed Finite Element Method (MFEM) to the VEF drift diffusion equations. 

\subsection{Lumped Linear Discontinuous Galerkin \SN}
The LLDG discretization of Eq. \ref{eq:si} is: 
	\begin{subequations} 
	\begin{equation} \label{eq:lldg_l}
		\mu_n \left(\psi_{n,i}\rellh - \psi_{n, i-1/2}\rellh\right) 
		+ \frac{\sigma_{t,i} h_i}{2} \psi_{n,i,L}\rellh
		= \frac{\sigma_{s,i} h_i}{4} \phi_{i,L}\rell + \frac{h_i}{4} Q_{i,L} \,, 
		% 1 \leq n \leq N \,, 
		% 1 \leq i \leq I\,, 
	\end{equation}
	\begin{equation} \label{eq:lldg_r}
		\mu_n \left(\psi_{n,i+1/2}\rellh - \psi_{n,i}\rellh\right) 
		+ \frac{\sigma_{t,i} h_i}{2} \psi_{n,i,R}\rellh
		= \frac{\sigma_{s,i} h_i}{4} \phi_{i,R}\rell + \frac{h_i}{4} Q_{i,R} \,, 
		% 1 \leq n \leq N \,, 
		% 1 \leq i \leq I\,,
	\end{equation}
	\end{subequations}
where $h_i$, $\sigma_{t,i}$, and $\sigma_{s,i}$ are the cell width, total cross section and scattering cross section in cell $i$. The $i,L$ and $i,R$ subscripts indicate the the subscripted value is the left or right discontinuous edge value. The cell centered angular flux is the average of the left and right discontinuous edge fluxes:
	\begin{equation} \label{eq:lldg_i}
		\psi_{n,i}\rellh = \half\left(\psi_{n,i,L}\rellh + \psi_{n,i,R}\rellh\right) \,,
	\end{equation}
and the cell edged angular fluxes are defined through upwinding: 
	\begin{subequations}
	\begin{equation} \label{eq:downwind}
		\psi_{n,i-1/2}\rellh = \begin{cases}
			\psi_{n,i-1,R}\rellh \,, & \mu_n > 0 \\ 
			\psi_{n,i,L}\rellh \,, & \mu_n < 0 
		\end{cases} \,,
	\end{equation}
	\begin{equation} \label{eq:upwind}
		\psi_{n,i+1/2}\rellh = \begin{cases}
			\psi_{n,i,R}\rellh \,, & \mu_n > 0 \\
			\psi_{n,i+1,L}\rellh \,, & \mu_n < 0 
		\end{cases} \,.
	\end{equation}
	\end{subequations}
Equations \ref{eq:lldg_l}, \ref{eq:lldg_r}, \ref{eq:lldg_i}, \ref{eq:downwind}, and \ref{eq:upwind} can be combined and rewritten as 
	\begin{equation} \label{eq:sweepLR}
		\left[\begin{matrix}
			\mu_n + \sigma_{t,i} h_i & \mu_n  \\ 
			-\mu_n & \sigma_{t,i} + \mu_n \\ 
		\end{matrix}\right]
		\left[\begin{matrix}
			\psi_{n,i,L}\rellh \\ \psi_{n,i,R}\rellh
		\end{matrix}\right]
		= \left[\begin{matrix}
			\frac{\sigma_{s,i}h_i}{2} \phi_{i,L}\rell + \frac{h_i}{2} Q_{i,L} + 2\mu_n \psi_{n,i-1,R}\rellh \\
			\frac{\sigma_{s,i}h_i}{2} \phi_{i,R}\rell + \frac{h_i}{2} Q_{i,R} 
		\end{matrix}\right] \,, 
	\end{equation}
for sweeping from left to right ($\mu_n > 0$) and 
	\begin{equation} \label{eq:sweepRL}
		\left[\begin{matrix} 
			-\mu_n + \sigma_{t,i}h_i & \mu_n \\ 
			-\mu_n & -\mu_n + \sigma_{t,i}h_i \\ 
		\end{matrix} \right]
		\left[\begin{matrix}
			\psi_{n,i,L}\rellh \\ \psi_{n,i,R}\rellh
		\end{matrix} \right]
		= \left[\begin{matrix}
			\frac{\sigma_{s,i}h_i}{2} \phi_{i,L}\rell + \frac{h_i}{2} Q_{i,L} \\ 
			\frac{\sigma_{s,i}h_i}{2} \phi_{i,R}\rell + \frac{h_i}{2} Q_{i,R} - 2\mu_n \psi_{n,i+1,L}\rellh
		\end{matrix} \right]
		\,, 
	\end{equation}
for sweeping from right to left ($\mu_n < 0$). The right hand sides of Eqs. \ref{eq:sweepLR} and \ref{eq:sweepRL} are known as the scalar flux from the previous iteration, the fixed source, and the angular flux entering from the previous cell are all known. By supplying the flux entering the left side of the first cell, the positive-angled solution can be propagated from left to right by solving Eq. \ref{eq:sweepLR}. Similarly, supplying the incident flux on the right boundary allows the negative-angled solution to be propagated from right to left with Eq. \ref{eq:sweepRL}. 

\subsection{Mixed Finite Element Method VEF Drift Diffusion}
Applying the MFEM to Eqs. \ref{eq:zero} and \ref{eq:first} and enforcing continuity of current yields: 
	\begin{subequations} \label{eq:mfem}
	\begin{equation}
		-\frac{6}{\sigma_{t,i}h_i} \edd_{i-1/2} \phi_{i-1/2}
		+ \left(\frac{12}{\sigma_{t,i}h_i} \edd_i + \sigma_{a,i} h_i\right) \phi_i 
		- \frac{6}{\sigma_{t,i} h_i} \edd_{i+1/2} \phi_{i+1/2} 
		= Q_i h_i \,,
	\end{equation}
	\begin{multline}
		-\frac{2}{\sigma_{t,i} h_i} \edd_{i-1/2}\phi_{i-1/2} + 
		\frac{6}{\sigma_{t,i} h_i} \edd_i \phi_i 
		- 4\left(\frac{1}{\sigma_{t,i} h_i} + \frac{1}{\sigma_{t,i+1} h_{i+1}}\right) 
			\edd_{i+1/2} \phi_{i+1/2}
		\\ + \frac{6}{\sigma_{t,i+1} h_{i+1}} \edd_{i+1} \phi_{i+1} 
		- \frac{2}{\sigma_{t,i+1} h_{i+1}} \edd_{i+3/2} \phi_{i+3/2} 
		= 0 \,,
	\end{multline}
	\end{subequations}
where the Eddington factor is evaluated at iteration $\ell+1/2$ and the scalar flux at $\ell+1$. 
Here, the Eddington factor has been assumed to be constant in each cell with discontinuous jumps at the edges. 
The simplest method of converting the Eddington factor from LLDG to MFEM is to compute the Eddington factor using the cell centered and cell edged angular fluxes using Eqs. \ref{eq:lldg_i}, \ref{eq:downwind}, and \ref{eq:upwind}. 

A more consistent way to transfer the Eddington factor is to represent it as a linear function using the MFEM basis functions:
	\begin{equation} \label{eq:eddquad}
		\edd_i(x) = \frac{
			\sum_{n=1}^N \mu_n^2 \left[\psi_{n,i,L}B_{i,L}(x) + \psi_{n,i,R} B_{i,R}(x)\right]
		}
		{
			B_{i,L}(x) \sum_{n=1}^N w_n \psi_{n,i,L} + B_{i,R}(x) \sum_{n=1}^N w_n \psi_{n,i,R} 
		}
	\end{equation}
where 
	\begin{equation}
		B_{i,L}(x) = \begin{cases}
			\frac{x_{i+1/2} - x}{h_i} \,, & x \in [x_{i-1/2}, x_{i+1/2}] \\ 
			0 \,, & \text{otherwise}
		\end{cases}
	\end{equation}
and 
	\begin{equation}
		B_{i,R}(x) = \begin{cases}
			\frac{x - x_{i-1/2}}{h_i} \,, & x \in [x_{i-1/2}, x_{i+1/2}] \\ 
			0 \,, & \text{otherwise}
		\end{cases} \,.
	\end{equation}
When MFEM is applied, the integral over cell $i$ of Eq. \ref{eq:eddquad} is approximated with 2 point Gauss quadrature. The cell centered Eddington factors used in Eq. \ref{eq:mfem} are then: 
	\begin{equation} 
		\edd_i = \half \left[ \edd_i(x_L) + \edd_i(x_R) \right]
	\end{equation}
where 
	\begin{equation}
		x_{L/R} = \frac{x_{i+1/2} - x_{i-1/2}}{2} \mp \frac{x_{i+1/2} + x_{i-1/2}}{2\sqrt{3}}
	\end{equation}
are the transformed quadrature points. 

Transport consistent boundary conditions are applied through a modified Marshak boundary condition: 
	\begin{equation} 
		J(x) = B(x) \phi(x) 
	\end{equation} 
where 
	\begin{equation} 
		B(x) = \frac{\int_{-1}^1 |\mu| \psi(x, \mu) \ud \mu}
		{\int_{-1}^1 \psi(x, \mu) \ud \mu} \,. 
	\end{equation}

Once the MFEM scalar flux has been found, the LLDG scattering term must be reconstructed. Two methods have been tested: no reconstruction and van Leer cell centered slope reconstruction. The no reconstruction method sets the LLDG discontinuous left and right scalar flux to the MFEM edge scalar flux: 
	\begin{equation} 
		\phi_{i,L/R} = \phi_{i\mp1/2} \,,
	\end{equation} 
where the left hand side is reconstructed LLDG flux used in the scattering term of Eq. \ref{eq:si} and the right hand side the MFEM drift diffusion flux. The van Leer cell centered reconstruction is: 
	\begin{equation} 
		\phi_{i,L/R} = \phi_i \mp \frac{1}{4} \xi_\text{van Leer} \left[\left(\phi_{i+1} - \phi_i\right) + \left(\phi_i - \phi_{i-1}\right) \right] \,,
	\end{equation}
where $\xi_\text{van Leer}$ is the van Leer is the slope limiter given in \cite{}. 